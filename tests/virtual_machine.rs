mod common;

#[cfg(test)]
mod vm_tests {
    use crate::common::MockStreamBuilder;
    use jdwp_client::JdwpClient;

    #[tokio::test]
    async fn test_mock_connect() {
        let mock_stream = MockStreamBuilder::default().build();
        _ = JdwpClient::new(mock_stream).await.unwrap();
    }

    #[tokio::test]
    async fn test_version_cmd() {
        let mock_stream = MockStreamBuilder::default()
            .response_bytes(
                &[0x01, 0x01],
                &[
                    // Length: 0xE1, packet id: 0x2, reply packet, version data:
                    // Java Debug Wire Protocol (Reference Implementation) version 21.0
                    // JVM Debug Interface version 21.0
                    // JVM version 21.0.8 (OpenJDK 64-Bit Server VM, mixed mode, sharing)21.0.8OpenJDK 64-Bit Server VM
                    0x0, 0x0, 0x0, 0xe1, 0x0, 0x0, 0x0, 0x2, 0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0xa4,
                    0x4a, 0x61, 0x76, 0x61, 0x20, 0x44, 0x65, 0x62, 0x75, 0x67, 0x20, 0x57, 0x69,
                    0x72, 0x65, 0x20, 0x50, 0x72, 0x6f, 0x74, 0x6f, 0x63, 0x6f, 0x6c, 0x20, 0x28,
                    0x52, 0x65, 0x66, 0x65, 0x72, 0x65, 0x6e, 0x63, 0x65, 0x20, 0x49, 0x6d, 0x70,
                    0x6c, 0x65, 0x6d, 0x65, 0x6e, 0x74, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x29, 0x20,
                    0x76, 0x65, 0x72, 0x73, 0x69, 0x6f, 0x6e, 0x20, 0x32, 0x31, 0x2e, 0x30, 0xa,
                    0x4a, 0x56, 0x4d, 0x20, 0x44, 0x65, 0x62, 0x75, 0x67, 0x20, 0x49, 0x6e, 0x74,
                    0x65, 0x72, 0x66, 0x61, 0x63, 0x65, 0x20, 0x76, 0x65, 0x72, 0x73, 0x69, 0x6f,
                    0x6e, 0x20, 0x32, 0x31, 0x2e, 0x30, 0xa, 0x4a, 0x56, 0x4d, 0x20, 0x76, 0x65,
                    0x72, 0x73, 0x69, 0x6f, 0x6e, 0x20, 0x32, 0x31, 0x2e, 0x30, 0x2e, 0x38, 0x20,
                    0x28, 0x4f, 0x70, 0x65, 0x6e, 0x4a, 0x44, 0x4b, 0x20, 0x36, 0x34, 0x2d, 0x42,
                    0x69, 0x74, 0x20, 0x53, 0x65, 0x72, 0x76, 0x65, 0x72, 0x20, 0x56, 0x4d, 0x2c,
                    0x20, 0x6d, 0x69, 0x78, 0x65, 0x64, 0x20, 0x6d, 0x6f, 0x64, 0x65, 0x2c, 0x20,
                    0x73, 0x68, 0x61, 0x72, 0x69, 0x6e, 0x67, 0x29, 0x0, 0x0, 0x0, 0x15, 0x0, 0x0,
                    0x0, 0x0, 0x0, 0x0, 0x0, 0x6, 0x32, 0x31, 0x2e, 0x30, 0x2e, 0x38, 0x0, 0x0,
                    0x0, 0x18, 0x4f, 0x70, 0x65, 0x6e, 0x4a, 0x44, 0x4b, 0x20, 0x36, 0x34, 0x2d,
                    0x42, 0x69, 0x74, 0x20, 0x53, 0x65, 0x72, 0x76, 0x65, 0x72, 0x20, 0x56, 0x4d,
                ],
            )
            .build();
        let client = JdwpClient::new(mock_stream).await.unwrap();
        let version_data = client.vm_get_version().await.unwrap();
        assert_eq!(
            version_data.description,
            "Java Debug Wire Protocol (Reference Implementation) version 21.0\nJVM Debug Interface version 21.0\nJVM version 21.0.8 (OpenJDK 64-Bit Server VM, mixed mode, sharing)"
        );
        assert_eq!(version_data.jdwp_major, 21);
        assert_eq!(version_data.jdwp_minor, 0);
        assert_eq!(version_data.vm_name, "OpenJDK 64-Bit Server VM");
        assert_eq!(version_data.vm_version, "21.0.8");
    }
}
