mod common;

#[cfg(test)]
mod vm_tests {
    use crate::common::MockStreamBuilder;
    use jdwp_client::{ClassStatus, JdwpClient, TypeTag};

    #[tokio::test]
    async fn test_mock_connect() {
        let mock_stream = MockStreamBuilder::default().build();
        _ = JdwpClient::new(mock_stream).await.unwrap();
    }

    #[tokio::test]
    async fn test_version_cmd() {
        let mock_stream = MockStreamBuilder::default()
            .response_bytes(
                &[0x01, 0x01],
                &[
                    // Length: 0xE1, packet id: 0x2, reply packet, version data:
                    // Java Debug Wire Protocol (Reference Implementation) version 21.0
                    // JVM Debug Interface version 21.0
                    // JVM version 21.0.8 (OpenJDK 64-Bit Server VM, mixed mode, sharing)21.0.8OpenJDK 64-Bit Server VM
                    0x0, 0x0, 0x0, 0xe1, 0x0, 0x0, 0x0, 0x2, 0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0xa4,
                    0x4a, 0x61, 0x76, 0x61, 0x20, 0x44, 0x65, 0x62, 0x75, 0x67, 0x20, 0x57, 0x69,
                    0x72, 0x65, 0x20, 0x50, 0x72, 0x6f, 0x74, 0x6f, 0x63, 0x6f, 0x6c, 0x20, 0x28,
                    0x52, 0x65, 0x66, 0x65, 0x72, 0x65, 0x6e, 0x63, 0x65, 0x20, 0x49, 0x6d, 0x70,
                    0x6c, 0x65, 0x6d, 0x65, 0x6e, 0x74, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x29, 0x20,
                    0x76, 0x65, 0x72, 0x73, 0x69, 0x6f, 0x6e, 0x20, 0x32, 0x31, 0x2e, 0x30, 0xa,
                    0x4a, 0x56, 0x4d, 0x20, 0x44, 0x65, 0x62, 0x75, 0x67, 0x20, 0x49, 0x6e, 0x74,
                    0x65, 0x72, 0x66, 0x61, 0x63, 0x65, 0x20, 0x76, 0x65, 0x72, 0x73, 0x69, 0x6f,
                    0x6e, 0x20, 0x32, 0x31, 0x2e, 0x30, 0xa, 0x4a, 0x56, 0x4d, 0x20, 0x76, 0x65,
                    0x72, 0x73, 0x69, 0x6f, 0x6e, 0x20, 0x32, 0x31, 0x2e, 0x30, 0x2e, 0x38, 0x20,
                    0x28, 0x4f, 0x70, 0x65, 0x6e, 0x4a, 0x44, 0x4b, 0x20, 0x36, 0x34, 0x2d, 0x42,
                    0x69, 0x74, 0x20, 0x53, 0x65, 0x72, 0x76, 0x65, 0x72, 0x20, 0x56, 0x4d, 0x2c,
                    0x20, 0x6d, 0x69, 0x78, 0x65, 0x64, 0x20, 0x6d, 0x6f, 0x64, 0x65, 0x2c, 0x20,
                    0x73, 0x68, 0x61, 0x72, 0x69, 0x6e, 0x67, 0x29, 0x0, 0x0, 0x0, 0x15, 0x0, 0x0,
                    0x0, 0x0, 0x0, 0x0, 0x0, 0x6, 0x32, 0x31, 0x2e, 0x30, 0x2e, 0x38, 0x0, 0x0,
                    0x0, 0x18, 0x4f, 0x70, 0x65, 0x6e, 0x4a, 0x44, 0x4b, 0x20, 0x36, 0x34, 0x2d,
                    0x42, 0x69, 0x74, 0x20, 0x53, 0x65, 0x72, 0x76, 0x65, 0x72, 0x20, 0x56, 0x4d,
                ],
            )
            .build();
        let client = JdwpClient::new(mock_stream).await.unwrap();
        let version_data = client.vm_get_version().await.unwrap();
        assert_eq!(
            version_data.description,
            "Java Debug Wire Protocol (Reference Implementation) version 21.0\nJVM Debug Interface version 21.0\nJVM version 21.0.8 (OpenJDK 64-Bit Server VM, mixed mode, sharing)"
        );
        assert_eq!(version_data.jdwp_major, 21);
        assert_eq!(version_data.jdwp_minor, 0);
        assert_eq!(version_data.vm_name, "OpenJDK 64-Bit Server VM");
        assert_eq!(version_data.vm_version, "21.0.8");
    }

    #[tokio::test]
    async fn test_classes_by_signature_cmd() {
        let mock_stream = MockStreamBuilder::default()
            .response_bytes(
                &[
                    // full packet with body, length=0x21c, id=0x2, cmd: (0x1 << 8) | 2
                    // signature: Lhello/HelloWorld;
                    0x00, 0x00, 0x00, 0x21, 0x00, 0x00, 0x00, 0x02, 0x00, 0x01, 0x02, 0x00, 0x00,
                    0x00, 0x12, 0x4c, 0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x2f, 0x48, 0x65, 0x6c, 0x6c,
                    0x6f, 0x57, 0x6f, 0x72, 0x6c, 0x64, 0x3b,
                ],
                &[
                    // reply, length=0x1c, id=0x2
                    // one class, ref_type_tag=1 (class), type_id=1 (8 byte long), status=7
                    0x00, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x02, 0x80, 0x00, 0x00, 0x00, 0x00,
                    0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00,
                    0x00, 0x07,
                ],
            )
            .build();
        let client = JdwpClient::new(mock_stream).await.unwrap();
        let reply = client
            .vm_get_classes_by_signature("Lhello/HelloWorld;")
            .await
            .unwrap();
        assert_eq!(reply.classes.len(), 1, "Invalid classes vector length");

        let class = &reply.classes[0];
        assert_eq!(
            class.ref_type_tag,
            TypeTag::Class,
            "Reference type tag does not match"
        );
        assert_eq!(
            class.status,
            ClassStatus::VERIFIED | ClassStatus::PREPARED | ClassStatus::INITIALIZED,
            "Class status does not match"
        );
        assert_eq!(class.type_id.value, 1, "Class type id does not match");
    }
}
